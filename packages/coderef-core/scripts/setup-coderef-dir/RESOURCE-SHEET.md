# Setup-Coderef-Dir Script - Resource Sheet

**Category:** Utility Script / Directory Initializer  
**Type:** Python CLI Tool  
**Directory:** `packages/coderef-core/scripts/setup-coderef-dir/`  
**Created:** 2026-01-04  
**Status:** ‚úÖ Production-ready (all tests passing)  
**Version:** 1.0.0

---

**Generated by:** Resource Sheet Generation  
**Last Updated:** 2026-01-07  
**Maintained by:** CodeRef Core Team

---

## Executive Summary

The `setup-coderef-dir` script directory contains a Python utility that creates standardized CodeRef directory structures in any project. It initializes both the hidden `.coderef/` technical directory (for analysis outputs) and the visible `coderef/` workflow directory (for workorders, standards, and documentation). This tool separates structural setup from data generation, ensuring consistent project organization across the CodeRef ecosystem.

**Key Characteristics:**
- **Idempotent:** Safe to run multiple times without side effects
- **Cross-platform:** Works on Windows, macOS, Linux
- **Zero dependencies:** Uses only Python standard library
- **Tested:** All 3 unit tests passing
- **CLI-ready:** Can be run manually or integrated into automation

## Directory Structure

```
scripts/setup-coderef-dir/
‚îú‚îÄ‚îÄ setup_coderef_dirs.py      # Main script (126 lines)
‚îú‚îÄ‚îÄ test_setup_coderef_dirs.py  # Unit tests (82 lines)
‚îú‚îÄ‚îÄ USAGE.md                    # User documentation
‚îú‚îÄ‚îÄ RESOURCE-SHEET.md          # This file
‚îî‚îÄ‚îÄ __pycache__/               # Python bytecode cache (generated)
```

## Files Overview

### 1. `setup_coderef_dirs.py` (Main Script)

**Purpose:** Creates standardized CodeRef directory structure

**Key Functions:**
- `create_structure(project_path: str, dry_run: bool = False) -> dict`
  - Main function that creates directory structure
  - Returns status dictionary with `success`, `created`, `skipped`, `errors`
  - Idempotent: safe to run multiple times

**Command-Line Interface:**
```bash
python setup_coderef_dirs.py [project_path] [--dry-run]
```

**Arguments:**
- `project_path` (optional): Path to project root directory (default: current directory `.`)
- `--dry-run`: Preview changes without creating directories

**Exit Codes:**
- `0`: Success (all directories created or already exist)
- `1`: Error (path not found, permission denied, etc.)

**Output Format:**
```
Setting up Coderef structure in: /path/to/project

[CREATE] .coderef/
  [CREATE] .coderef/reports/complexity/
  [CREATE] .coderef/diagrams/
  [CREATE] .coderef/exports/
[CREATE] coderef/
  [CREATE] coderef/workorder/
  [CREATE] coderef/archived/
  ...
```

### 2. `test_setup_coderef_dirs.py` (Test Suite)

**Purpose:** Unit tests for directory creation functionality

**Test Cases:**
1. **`test_create_structure_creates_all_dirs`**
   - Verifies all 10 directories are created
   - Checks both parent directories (`.coderef/`, `coderef/`)
   - Validates all 8 subdirectories

2. **`test_dry_run_does_not_create_dirs`**
   - Ensures dry-run mode doesn't create any directories
   - Verifies preview functionality works correctly

3. **`test_idempotency`**
   - Tests that running the script twice doesn't fail
   - Verifies second run skips existing directories
   - Confirms `skipped` array is populated correctly

**Test Execution:**
```bash
cd packages/coderef-core/scripts/setup-coderef-dir
python test_setup_coderef_dirs.py
```

**Test Coverage:** ‚úÖ 3/3 tests passing

### 3. `USAGE.md` (User Documentation)

**Purpose:** Quick reference guide for end users

**Contents:**
- Basic usage examples
- Command-line options
- Directory structure overview
- Troubleshooting tips
- Integration status (CLI ‚úÖ, Scanner UI ‚ùå blocked)

## Directory Structure Created

### `.coderef/` (Hidden, Technical)

**Purpose:** Stores analysis outputs, reports, and generated artifacts

**Subdirectories:**
- `reports/complexity/` - Complexity analysis reports
- `diagrams/` - Visual dependency diagrams (Mermaid, DOT)
- `exports/` - Export formats (JSON-LD, DOT, Mermaid)

**Total:** 1 parent + 3 subdirectories = 4 directories

### `coderef/` (Visible, Workflow)

**Purpose:** Stores workflow management files, standards, and documentation

**Subdirectories:**
- `workorder/` - Active feature implementations
- `archived/` - Completed features
- `standards/` - UI/UX/behavior standards
- `documents/` - Foundation docs (ARCHITECTURE, API, etc.)
- `reference/` - Reference implementations and patterns
- `user/` - User-specific notes and customizations
- `notes/` - General project notes

**Total:** 1 parent + 7 subdirectories = 8 directories

**Grand Total:** 10 directories (2 parents + 8 subdirectories)

## Architecture & Design

### Design Principles

1. **Separation of Concerns**
   - This script: Directory structure only
   - `scan-all.py`: Generates `.coderef/index.json` and `context.md`
   - `populate-coderef.py`: Generates complete `.coderef/` outputs (reports, diagrams, exports)

2. **Idempotency**
   - Safe to run multiple times
   - Skips existing directories
   - No destructive operations

3. **Error Resilience**
   - Continues creating other directories if one fails
   - Returns complete status with all successes and failures
   - Clear error messages

4. **Cross-Platform Compatibility**
   - Uses `pathlib.Path` for path handling
   - Works on Windows (`\`), macOS/Linux (`/`)
   - Handles relative and absolute paths

### Implementation Details

**Language:** Python 3.10+  
**Dependencies:** Standard library only
- `pathlib.Path` - Cross-platform path handling
- `argparse` - Command-line argument parsing
- `sys` - Exit codes

**Key Algorithms:**

1. **Path Resolution:**
   ```python
   project = Path(project_path).resolve()  # Absolute path
   ```

2. **Directory Creation:**
   ```python
   if not parent_dir.exists():
       parent_dir.mkdir(parents=True, exist_ok=True)
   ```

3. **Nested Path Handling:**
   ```python
   # 'reports/complexity' creates both directories
   target.mkdir(parents=True, exist_ok=True)
   ```

## Integration Points

### Current Integration Status

| Integration | Status | Notes |
|-------------|--------|-------|
| **CLI (Manual)** | ‚úÖ Working | Use instructions in USAGE.md |
| **Scanner UI** | ‚ùå Blocked | Node.js spawn() issue (cmd.exe ENOENT) |
| **Automated Workflow** | üöß Planned | Will work once UI integration fixed |

### Integration with Scanner

**File:** `packages/dashboard/src/app/api/scanner/lib/scanExecutor.ts`

**Current Implementation (BLOCKED):**
```typescript
private async runDirectoriesForProject(projectPath: string): Promise<void> {
  const dirsScriptPath = process.env.DIRS_SCRIPT_PATH ||
    path.join(process.cwd(), 'packages/coderef-core/scripts/setup-coderef-dir/setup_coderef_dirs.py');
  
  const pythonCmd = await this.findPythonCommand();
  
  // Spawn Python subprocess (BLOCKED on Windows)
  const { stdout, stderr } = await execAsync(
    `"${pythonCmd}" "${dirsScriptPath}" "${projectPath}"`,
    { cwd: path.dirname(dirsScriptPath) }
  );
}
```

**Error:** `spawn C:\WINDOWS\system32\cmd.exe ENOENT`

**Workaround:** Manual CLI execution (see USAGE.md)

**Future Solution:** TypeScript port (see `coderef/workorder/fix-windows-spawn-exec/typescript-port-solution.md`)

### Environment Variables

**`DIRS_SCRIPT_PATH`** (optional)
- Default: `packages/coderef-core/scripts/setup-coderef-dir/setup_coderef_dirs.py`
- Override: Set to custom script path if needed

## API Contract

### Function Signature

```python
def create_structure(project_path: str, dry_run: bool = False) -> dict:
    """
    Creates the standard Coderef directory structure.
    
    Args:
        project_path: Path to project root directory
        dry_run: If True, preview without creating directories
    
    Returns:
        dict with keys:
            - success: bool - Overall success status
            - created: list[str] - Paths that were created
            - skipped: list[str] - Paths that already existed
            - errors: list[str] - Error messages (if any)
    """
```

### Return Value Structure

```python
{
    'success': True,  # or False if errors occurred
    'created': [
        '/path/to/project/.coderef',
        '/path/to/project/.coderef/reports/complexity',
        '/path/to/project/coderef',
        '/path/to/project/coderef/workorder',
        # ... all created directories
    ],
    'skipped': [
        '/path/to/project/coderef/standards',  # Already existed
        # ... all existing directories
    ],
    'errors': []  # Empty if no errors, or list of error messages
}
```

### Error Handling

**Path Not Found:**
```python
{
    'success': False,
    'created': [],
    'skipped': [],
    'errors': ['Path not found']
}
```

**Permission Denied:**
```python
{
    'success': False,
    'created': ['/path/to/.coderef'],  # Some may succeed
    'skipped': [],
    'errors': ['Failed to create /path/to/coderef: Permission denied']
}
```

## Testing

### Test Suite

**File:** `test_setup_coderef_dirs.py`  
**Framework:** Python `unittest`  
**Coverage:** 3 test cases, all passing

**Test Execution:**
```bash
cd packages/coderef-core/scripts/setup-coderef-dir
python test_setup_coderef_dirs.py
```

**Expected Output:**
```
...
----------------------------------------------------------------------
Ran 3 tests in 0.001s

OK
```

### Test Cases

1. **`test_create_structure_creates_all_dirs`**
   - **Purpose:** Verify all expected directories are created
   - **Validates:**
     - Both parent directories exist (`.coderef/`, `coderef/`)
     - All 8 subdirectories exist
     - `result['success']` is `True`
     - `result['created']` contains all 10 directories

2. **`test_dry_run_does_not_create_dirs`**
   - **Purpose:** Ensure dry-run mode doesn't create directories
   - **Validates:**
     - No directories exist after dry-run
     - `result['success']` is `True`
     - `result['created']` is empty

3. **`test_idempotency`**
   - **Purpose:** Verify script can be run multiple times safely
   - **Validates:**
     - First run creates directories
     - Second run doesn't fail
     - Second run skips existing directories
     - `result['skipped']` contains directories from first run

### Manual Testing

**Test on Windows:**
```bash
cd C:\Users\willh\Desktop\coderef-dashboard
py packages/coderef-core/scripts/setup-coderef-dir/setup_coderef_dirs.py "C:\path\to\test-project"
```

**Verify directories created:**
```bash
dir "C:\path\to\test-project\.coderef"
dir "C:\path\to\test-project\coderef"
```

## Usage Examples

### Basic Usage

**Create structure in current directory:**
```bash
python setup_coderef_dirs.py
```

**Create structure in specific project:**
```bash
python setup_coderef_dirs.py /path/to/project
```

**Windows with py launcher:**
```bash
py packages/coderef-core/scripts/setup-coderef-dir/setup_coderef_dirs.py "C:\path\to\project"
```

### Dry-Run Mode

**Preview without creating:**
```bash
python setup_coderef_dirs.py /path/to/project --dry-run
```

**Output:**
```
[DRY-RUN] Would create: /path/to/project/.coderef
  [DRY-RUN] Would create: /path/to/project/.coderef/reports/complexity
  ...
```

### Programmatic Usage

**From Python:**
```python
from setup_coderef_dirs import create_structure

result = create_structure('/path/to/project')
if result['success']:
    print(f"Created {len(result['created'])} directories")
else:
    print(f"Errors: {result['errors']}")
```

**From Node.js (Future TypeScript port):**
```typescript
import { createCoderefStructure } from '@coderef-dashboard/core/utils/directory-setup';

const result = createCoderefStructure('/path/to/project');
if (result.success) {
  console.log(`Created ${result.created.length} directories`);
}
```

## Troubleshooting

### Common Issues

**1. "Python not found" error:**
- **Solution:** Use `py` launcher on Windows: `py setup_coderef_dirs.py`
- **Alternative:** Use full path: `python3 setup_coderef_dirs.py`

**2. "Permission denied" error:**
- **Solution:** Run command prompt as Administrator
- **Check:** Verify write permissions to target directory

**3. "Path not found" error:**
- **Solution:** Use absolute paths (not relative)
- **Check:** Ensure project path exists
- **Windows:** Use quotes around paths with spaces

**4. Node.js spawn() issues (Scanner UI):**
- **Current Status:** Blocked on Windows (cmd.exe ENOENT)
- **Workaround:** Use manual CLI execution
- **Future:** TypeScript port eliminates subprocess dependency

## Related Resources

### Internal Documentation

- **`coderef/resource/Setup-Coderef-Dir-RESOURCE-SHEET.md`** - High-level overview
- **`coderef/workorder/fix-windows-spawn-exec/plan.md`** - Windows spawn fix plan
- **`coderef/workorder/fix-windows-spawn-exec/typescript-port-solution.md`** - TypeScript port details
- **`scripts/setup-coderef-dir/USAGE.md`** - User-facing documentation

### Related Scripts

- **`scan-all.py`** - Generates minimal `.coderef/` data (index.json, context.md)
- **`populate-coderef.py`** - Generates complete `.coderef/` outputs (reports, diagrams, exports)

### Integration Points

- **`packages/dashboard/src/app/api/scanner/lib/scanExecutor.ts`** - Scanner integration (Phase 0)
- **`coderef/resource/SCAN-EXECUTOR.md`** - Scanner executor documentation

## Future Enhancements

### Planned Improvements

1. **TypeScript Port** (High Priority)
   - Eliminate Python dependency
   - Fix Windows spawn() issues
   - Improve performance (20-30x faster)
   - See: `coderef/workorder/fix-windows-spawn-exec/typescript-port-solution.md`

2. **Custom Structure Support**
   - Allow custom directory structures via config file
   - Support project-specific directory layouts

3. **Progress Reporting**
   - Real-time progress updates for long-running operations
   - Better integration with Scanner UI

4. **Validation**
   - Verify directory permissions before creation
   - Check disk space availability
   - Validate project path format

## Maintenance

### Version History

- **v1.0.0** (2026-01-04): Initial release
  - Basic directory creation
  - Dry-run support
  - Idempotent operation
  - All tests passing

### Maintenance Notes

- **Python Version:** Requires Python 3.10+
- **Dependencies:** Standard library only (no external packages)
- **Testing:** Run tests after any changes
- **Documentation:** Update USAGE.md if CLI changes

### Known Limitations

1. **Windows Integration:** Blocked by Node.js spawn() issues
2. **No Custom Structures:** Hardcoded directory structure
3. **No Progress Callbacks:** Synchronous execution only
4. **Python Dependency:** Requires Python runtime (will be fixed with TypeScript port)

---

**Last Updated:** 2026-01-07  
**Maintained by:** CodeRef Core Team  
**Status:** ‚úÖ Production-ready, all tests passing
