---
agent: Claude Sonnet 4.5
date: "2026-01-12"
task: UPDATE
subject: Prompting Workflow
parent_project: coderef-dashboard
category: other
version: 1.0.0
related_files:
  - packages/dashboard/src/lib/prompting-workflow.ts
status: APPROVED
---

# PromptingWorkflow - Resource Sheet

**Category:** UI Component / Workflow Orchestrator
**Type:** React Component (Client Component)
**File:** `packages/dashboard/src/components/PromptingWorkflow/components/PromptingWorkflow.tsx`
**Created:** 2026-01-02
**Lines of Code:** 304

---

**Generated by:** Resource Sheet Generation Workflow
**Timestamp:** 2026-01-02
**Auto-fill Rate:** Manual (comprehensive analysis)

---

## Executive Summary

**Element:** PromptingWorkflow
**Category:** Workflow Orchestrator Component
**Purpose:** Main container for the prompting workflow feature - orchestrates prompt selection, file attachments, export operations, and final result capture in a multi-step workflow

**Key Responsibilities:**
- Coordinate workflow state via WorkflowContext (prompt, attachments, tags)
- Validate workflow readiness for export (prompt + attachments required)
- Handle export operations (copy JSON, export JSON/Markdown files)
- Manage modal flows (ReviewTitle, PasteFinalResult)
- Generate filenames with timestamps
- Trigger browser downloads via Blob URLs
- Save workflow sessions to user-selected directories

**Not Responsible For:**
- Prompt library management (delegated to prompts utility)
- File attachment UI (delegated to AttachmentManager)
- Prompt selection UI (delegated to PromptSelector)
- JSON/Markdown formatting (delegated to exportFormatter utilities)
- Clipboard operations (delegated to useClipboard hook)

---

## Architecture Overview

### Component Hierarchy

```
PromptingWorkflow (this component)
‚îú‚îÄ‚îÄ Corner Accents (decorative UI)
‚îú‚îÄ‚îÄ PromptSelector
‚îÇ   ‚îú‚îÄ‚îÄ Prompt cards with tags
‚îÇ   ‚îî‚îÄ‚îÄ Tag filtering
‚îú‚îÄ‚îÄ AttachmentManager
‚îÇ   ‚îú‚îÄ‚îÄ File drop zone
‚îÇ   ‚îú‚îÄ‚îÄ Attachment list
‚îÇ   ‚îî‚îÄ‚îÄ Clear all button
‚îú‚îÄ‚îÄ WorkflowMeta
‚îÇ   ‚îî‚îÄ‚îÄ Workflow statistics (prompt info, attachment count)
‚îú‚îÄ‚îÄ ExportMenu
‚îÇ   ‚îú‚îÄ‚îÄ Copy JSON button
‚îÇ   ‚îú‚îÄ‚îÄ Export JSON button
‚îÇ   ‚îî‚îÄ‚îÄ Export Markdown button
‚îú‚îÄ‚îÄ Paste Final Result button
‚îú‚îÄ‚îÄ PasteFinalResultModal
‚îÇ   ‚îî‚îÄ‚îÄ Textarea for LLM output
‚îî‚îÄ‚îÄ ReviewTitleModal (conditional)
    ‚îî‚îÄ‚îÄ Input for review title (prompt 0004 only)
```

**Design Rationale:**
- **Container component pattern:** Orchestrates child components, no direct UI rendering
- **Context-driven state:** WorkflowContext provides global workflow state
- **Modal-based flows:** Complex interactions (review title, final result) use modals
- **Deferred execution:** Export actions queue via `pendingExportAction` state

### File Structure

**Location:** `packages/dashboard/src/components/PromptingWorkflow/components/PromptingWorkflow.tsx`

**Related Files:**
- `./PromptSelector.tsx` - Prompt selection UI with tag filtering
- `./AttachmentManager.tsx` - File attachment UI
- `./WorkflowMeta.tsx` - Workflow statistics display
- `./ExportMenu.tsx` - Export action buttons
- `./PasteFinalResultModal.tsx` - Modal for capturing LLM output
- `./ReviewTitleModal.tsx` - Modal for review title input (prompt 0004)
- `@/contexts/WorkflowContext.tsx` - Global workflow state
- `../hooks/useClipboard.ts` - Clipboard operations
- `../hooks/useFileHandlers.ts` - Directory selection
- `../utils/prompts.ts` - Prompt library
- `../utils/exportFormatter.ts` - JSON/Markdown generation

**Organization Strategy:**
- Main component is orchestrator only (no direct UI logic)
- Each workflow step has dedicated child component
- Utilities handle data transformation (export formatting)
- Hooks handle platform APIs (clipboard, file system)

### Dependencies

**Internal Dependencies:**
- `@/contexts/WorkflowContext` - Global workflow state management
- `./PromptSelector` - Prompt selection UI component
- `./AttachmentManager` - File attachment UI component
- `./WorkflowMeta` - Metadata display component
- `./ExportMenu` - Export buttons component
- `./PasteFinalResultModal` - Final result modal
- `./ReviewTitleModal` - Review title modal (prompt 0004)
- `../hooks/useClipboard` - Clipboard write hook
- `../hooks/useFileHandlers` - Directory selection hook
- `../utils/prompts` - getAllPrompts() function
- `../utils/exportFormatter` - generateJSON(), generateMarkdown()

**External Dependencies:**
- `react` (^18.2.0) - useState, useCallback hooks

**Dependency Choices:**
- **WorkflowContext instead of local state:** Enables sharing workflow across pages/components
- **Custom hooks for platform APIs:** Abstracts browser vs Electron differences
- **Separate export formatter:** Keeps formatting logic testable and reusable
- **useCallback for handlers:** Prevents unnecessary re-renders of child components

### Architectural Pattern

**Pattern:** Container/Presenter with Deferred Execution Queue

**Rationale:**
- **Container:** Handles logic and state coordination
- **Presenters:** Child components render UI based on props
- **Deferred Queue:** Export actions wait for modal input (review title)
- **Context-driven:** Workflow state lives in context, not local state

**Alternative Considered:** State machine (XState)
**Rejected Because:**
- Workflow is simple (linear steps: select ‚Üí attach ‚Üí export ‚Üí save)
- State machine overhead not justified
- Modal flows easier with simple pending action state

---

## Workflow State Machine

### Workflow States (Conceptual)

**State 1: Empty (Initial)**
- No prompt selected
- No attachments
- Export disabled

**State 2: Prompt Selected**
- Prompt selected
- No attachments yet
- Export disabled

**State 3: Ready for Export**
- Prompt selected
- Attachments added
- Export enabled

**State 4: Export Pending (Modal Flow)**
- User clicked export
- Modal open (ReviewTitle or PasteFinalResult)
- Waiting for user input

**State 5: Exported**
- Export completed
- Workflow can be reset or saved

### State Validation

**Export Readiness Check:**
```typescript
const isReadyForExport = workflow.selectedPrompt && workflow.attachments.length > 0;
```

**Why both conditions?**
- **Prompt required:** Export needs prompt content and metadata
- **Attachments required:** Workflow is about attaching files to prompts
- **At least 1 attachment:** Empty workflow is meaningless

**UI Feedback:**
```tsx
{!isReadyForExport && (
  <p>‚ö†Ô∏è Select a prompt and add at least one attachment to enable export</p>
)}
```

---

## Export Operations

### Export Flow Types

**1. Copy JSON (Direct)**
```
User clicks Copy JSON
  ‚Üì
Check if prompt 0004 (CODEREF_ECOSYSTEM_REVIEW)
  ‚Üì NO (standard prompt)
  ‚Üì
Generate JSON
  ‚Üì
Copy to clipboard
  ‚Üì
Done
```

**2. Copy JSON (With Review Title)**
```
User clicks Copy JSON
  ‚Üì
Check if prompt 0004
  ‚Üì YES
  ‚Üì
Set pendingExportAction = 'copy'
  ‚Üì
Show ReviewTitleModal
  ‚Üì
User enters title ‚Üí click Confirm
  ‚Üì
Generate JSON with reviewTitle
  ‚Üì
Copy to clipboard
  ‚Üì
Done
```

**3. Export JSON/Markdown (File Download)**
```
User clicks Export JSON/Markdown
  ‚Üì
Check if prompt 0004
  ‚Üì NO
  ‚Üì
Select directory (Electron) or trigger browser download
  ‚Üì
Generate JSON/Markdown
  ‚Üì
Create Blob ‚Üí download
  ‚Üì
Done
```

### Pending Action Queue

**Purpose:** Deferred execution for modal flows

**State:**
```typescript
const [pendingExportAction, setPendingExportAction] = useState<'copy' | 'json' | 'markdown' | null>(null);
```

**Why needed?**
- User clicks export ‚Üí modal opens
- Modal confirms ‚Üí need to know which export action to execute
- Queue stores intended action until modal resolves

**Flow:**
```typescript
// 1. User clicks export
handleCopyJSON() {
  if (prompt.key === '0004') {
    setPendingExportAction('copy');  // Queue action
    setShowReviewTitleModal(true);   // Show modal
    return;
  }
  // ... normal export
}

// 2. Modal confirms
handleReviewTitleConfirm(reviewTitle) {
  if (pendingExportAction === 'copy') {
    const json = generateJSON({ ...workflow, reviewTitle });
    copyToClipboard(json);
  }
  setPendingExportAction(null);  // Clear queue
}
```

### Special Case: Prompt 0004 (CODEREF_ECOSYSTEM_REVIEW)

**Why special handling?**
- Prompt 0004 requires review title for export filename
- Review title added to workflow metadata
- Modal captures title before export

**Detection:**
```typescript
if (workflow.selectedPrompt?.key === '0004') {
  setPendingExportAction('copy');
  setShowReviewTitleModal(true);
  return;
}
```

**Title Integration:**
```typescript
const workflowWithTitle = {
  ...workflow,
  reviewTitle, // Add to workflow object
};
const json = generateJSON(workflowWithTitle);
```

---

## File Download Implementation

### Browser Download (Fallback)

**Why needed?**
- Electron `selectDirectory()` might fail in browser
- Browser doesn't have native file system access
- Fallback to Blob download for compatibility

**Implementation:**
```typescript
const blob = new Blob([json], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);  // Cleanup memory
```

**Why this pattern?**
- **Blob URL:** Creates temporary downloadable URL from string data
- **Hidden anchor:** Programmatic click triggers download
- **Cleanup:** Remove anchor and revoke URL to free memory
- **Browser compatibility:** Works in all modern browsers

### Filename Generation

**Pattern:**
```typescript
const filename = `workflow_${workflow.selectedPrompt?.name}_${Date.now()}.json`;
// Example: workflow_CODEREF_ECOSYSTEM_REVIEW_1704123456789.json
```

**Why this format?**
- **Prefix:** `workflow_` identifies file type
- **Prompt name:** Identifies which prompt was used
- **Timestamp:** Ensures unique filenames (no overwrites)
- **Extension:** `.json` or `.md` for proper file handling

**For Review Title (Prompt 0004):**
```typescript
const filename = `workflow_${reviewTitle}_${Date.now()}.json`;
// Example: workflow_Scanner_Integration_1704123456789.json
```

---

## Modal Workflows

### Modal 1: PasteFinalResultModal

**Purpose:** Capture LLM output after user completes workflow externally

**Trigger:**
```tsx
<button onClick={() => setShowPasteFinalResult(true)}>
  üìù Paste Final LLM Result
</button>
```

**Flow:**
1. User completes workflow (prompt + attachments copied/exported)
2. User pastes to LLM (external: Claude, ChatGPT, etc.)
3. User copies LLM response
4. User clicks "Paste Final Result"
5. Modal opens ‚Üí user pastes response
6. Response saved to workflow context
7. Optional: Save entire session to file

**Save Session Option:**
```typescript
const shouldSaveWorkflow = confirm('Save this workflow to local storage?');
if (shouldSaveWorkflow) {
  const directory = await selectDirectory();
  const json = generateJSON({ ...workflow, finalResult: result });
  // Download session_1704123456789.json
}
```

**Why confirm()?**
- Native browser confirm dialog
- Simple yes/no decision
- No custom modal needed for binary choice

### Modal 2: ReviewTitleModal

**Purpose:** Capture review title for prompt 0004 exports

**Trigger:** Automatically when exporting with prompt key === '0004'

**Flow:**
1. User clicks export (Copy/JSON/Markdown)
2. Check: Is prompt 0004?
3. If yes: Show ReviewTitleModal
4. User enters title ‚Üí clicks Confirm
5. Execute queued export action with title

**Integration:**
```typescript
<ReviewTitleModal
  isOpen={showReviewTitleModal}
  onConfirm={handleReviewTitleConfirm}
  onClose={() => {
    setShowReviewTitleModal(false);
    setPendingExportAction(null);  // Clear queue on cancel
  }}
/>
```

**Why separate modal?**
- Prompt 0004 is special case (ecosystem review)
- Review title needed for semantic filenames
- Reusable modal for all 0004 export actions

---

## Integration Points

### Internal Integrations

**Components that use this:**
- `app/prompts/page.tsx` - Renders PromptingWorkflow as page content

**Components this uses:**
- **PromptSelector** - Prompt selection UI
  - Props: `prompts`, `selectedPromptKey`, `selectedTags`, callbacks
  - Callbacks: `onSelectPrompt`, `onToggleTag`
- **AttachmentManager** - File attachment UI
  - Props: `attachments`, callbacks
  - Callbacks: `onAddAttachments`, `onRemoveAttachment`, `onClearAll`
- **WorkflowMeta** - Metadata display (read-only)
  - Props: `prompt`, `attachments`
- **ExportMenu** - Export buttons
  - Props: `disabled`, callbacks
  - Callbacks: `onCopyJSON`, `onExportJSON`, `onExportMarkdown`
- **PasteFinalResultModal** - Final result modal
  - Props: `isOpen`, callbacks
  - Callbacks: `onResultSaved`, `onClose`
- **ReviewTitleModal** - Review title modal
  - Props: `isOpen`, callbacks
  - Callbacks: `onConfirm`, `onClose`

### External Integrations

**WorkflowContext:**
```typescript
const {
  workflow,                   // Current workflow state
  setSelectedPrompt,          // Set active prompt
  toggleTag,                  // Toggle tag filter
  addAttachments,             // Add files
  removeAttachment,           // Remove file
  clearAttachments,           // Remove all files
  setFinalResult,             // Save LLM output
} = useWorkflow();
```

**Clipboard API (via useClipboard hook):**
```typescript
const { write: copyToClipboard } = useClipboard();
await copyToClipboard(json);  // Returns success boolean
```

**File System (via useFileHandlers hook):**
```typescript
const { selectDirectory } = useFileHandlers();
const directory = await selectDirectory();  // Returns path or null
```

**Export Formatters:**
```typescript
import { generateJSON, generateMarkdown } from '../utils/exportFormatter';

const json = generateJSON(workflow);
const markdown = generateMarkdown(workflow);
```

### Data Flow

**Input:**
- No props (self-contained component)
- State from WorkflowContext

**Processing:**
1. Render child components with workflow state
2. Handle user actions (select prompt, add attachments, export)
3. Validate workflow readiness
4. Generate export data
5. Trigger downloads or copy to clipboard

**Output:**
- UI rendered with current workflow state
- Exported files (JSON, Markdown)
- Clipboard content (JSON)
- Saved sessions (JSON with final result)

**Event Flow:**
```
[User Action] ‚Üí [Handler] ‚Üí [Context Update] ‚Üí [Child Re-render]
[Export Action] ‚Üí [Generate Data] ‚Üí [Download/Clipboard] ‚Üí [Done]
```

---

## Error Handling

### Error Categories

**1. Validation Errors (User-facing)**
```typescript
if (!isReadyForExport) {
  alert('Please select a prompt and add attachments');
  return;
}
```

**Why alert()?**
- Simple validation message
- Blocks user action until acknowledged
- Better UX than silent failure

**2. Clipboard Errors**
```typescript
const success = await copyToClipboard(json);
if (!success) {
  throw new Error('Failed to copy to clipboard');
}
```

**Error propagation:**
- Throws error to be caught by error boundary
- User sees error UI instead of silent failure

**3. File System Errors**
```typescript
const directory = await selectDirectory();
if (!directory) return;  // User cancelled, no error
```

**Why no error?**
- User cancellation is not an error
- Silently abort operation
- No cleanup needed (no state changes yet)

### Error Recovery

**No Automatic Retry:**
- User-initiated actions should not auto-retry
- User can manually retry (click export again)
- Prevents infinite loops or unwanted side effects

**Graceful Degradation:**
- If Electron directory selection fails ‚Üí browser download fallback
- If clipboard API unavailable ‚Üí manual copy-paste from export

---

## Performance Considerations

### Performance Budgets

**Metrics:**
- Export generation time (JSON/Markdown)
- Clipboard write time
- File download time
- Modal open/close time

**Targets:**
- **Export generation:** <100ms (JSON stringify + formatting)
- **Clipboard write:** <50ms (native API)
- **File download:** Instant (browser handles async)
- **Modal animation:** <200ms (CSS transitions)

### Optimization Opportunities

**Quick Win: Memoize Export Data**
```typescript
const exportJSON = useMemo(() => {
  if (!isReadyForExport) return null;
  return generateJSON(workflow);
}, [workflow, isReadyForExport]);
```

**Why not implemented?**
- Export is user-initiated (not re-computed on every render)
- Generation is fast (<100ms)
- Premature optimization

**Future: Debounce Attachment Changes**
- If attachments change frequently (batch upload)
- Debounce WorkflowMeta recalculation
- Not needed for typical use (1-5 files added manually)

---

## Testing Strategy

### Coverage Gaps

**Missing Tests:**
- [ ] Test export validation (no prompt, no attachments)
- [ ] Test Review Title modal flow for prompt 0004
- [ ] Test pending action queue (modal ‚Üí export)
- [ ] Test file download fallback (browser vs Electron)
- [ ] Test clipboard error handling
- [ ] Test final result save flow

### Recommended Tests

**High Priority:**

**1. Test export readiness validation**
```typescript
test('should disable export when no prompt selected', () => {
  render(<PromptingWorkflow />);
  const copyButton = screen.getByText('Copy JSON');
  expect(copyButton).toBeDisabled();
});

test('should disable export when no attachments', () => {
  const { setSelectedPrompt } = useWorkflow();
  setSelectedPrompt(mockPrompt);

  render(<PromptingWorkflow />);
  const copyButton = screen.getByText('Copy JSON');
  expect(copyButton).toBeDisabled();
});
```

**2. Test Review Title modal flow**
```typescript
test('should show ReviewTitleModal for prompt 0004', async () => {
  const { setSelectedPrompt, addAttachments } = useWorkflow();
  setSelectedPrompt({ key: '0004', name: 'CODEREF_ECOSYSTEM_REVIEW' });
  addAttachments([mockFile]);

  render(<PromptingWorkflow />);
  fireEvent.click(screen.getByText('Copy JSON'));

  expect(screen.getByText('Enter Review Title')).toBeInTheDocument();
});
```

**3. Test pending action execution**
```typescript
test('should execute pending copy action after review title confirmed', async () => {
  // Setup prompt 0004 + attachments
  fireEvent.click(screen.getByText('Copy JSON'));

  // Modal appears
  const input = screen.getByPlaceholderText('Review Title');
  fireEvent.change(input, { target: { value: 'Scanner Integration' } });
  fireEvent.click(screen.getByText('Confirm'));

  expect(mockCopyToClipboard).toHaveBeenCalledWith(
    expect.stringContaining('Scanner Integration')
  );
});
```

---

## Common Pitfalls

### Pitfall 1: Forgetting to Clear Pending Action

**Issue:** Modal cancelled but pending action still set

**Wrong:**
```tsx
<ReviewTitleModal
  onClose={() => setShowReviewTitleModal(false)}
  // Missing: setPendingExportAction(null)
/>
```

**Correct:**
```tsx
<ReviewTitleModal
  onClose={() => {
    setShowReviewTitleModal(false);
    setPendingExportAction(null);  // Clear queue
  }}
/>
```

### Pitfall 2: Not Revoking Blob URLs

**Issue:** Memory leak from unreleased Blob URLs

**Wrong:**
```typescript
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.click();
// Missing: URL.revokeObjectURL(url)
```

**Correct:**
```typescript
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);  // Release memory
```

### Pitfall 3: Using Prompt Name Directly in Filename

**Issue:** Prompt names may contain special characters (spaces, slashes)

**Current Risk:**
```typescript
const filename = `workflow_${workflow.selectedPrompt?.name}_${Date.now()}.json`;
// If name = "Feature/Bug Review" ‚Üí invalid filename
```

**Better:**
```typescript
const safeName = workflow.selectedPrompt?.name.replace(/[^a-zA-Z0-9]/g, '_');
const filename = `workflow_${safeName}_${Date.now()}.json`;
```

---

## Footer

**Generated by:** Resource Sheet Generation Workflow
**Timestamp:** 2026-01-02
**Modules Used:** architecture, integration, workflow-orchestration, export-operations, testing
**Complexity Score:** High (304 lines, multi-modal flows, deferred execution, file downloads)

**Recommended Next Steps:**
1. Add comprehensive workflow tests
2. Implement filename sanitization for prompt names
3. Add error boundary for clipboard/file system failures
4. Consider memoizing export data for performance
5. Add analytics tracking for export actions

---

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
