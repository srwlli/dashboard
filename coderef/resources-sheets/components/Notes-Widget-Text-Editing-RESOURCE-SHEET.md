---
agent: Claude Sonnet 4.5
date: "2026-01-12"
task: UPDATE
subject: Notes Widget Text Editing
parent_project: coderef-dashboard
category: component
version: 1.0.0
related_files:
  - packages/dashboard/src/components/widgets/NotesWidget/index.tsx
status: APPROVED
---

# Notes Widget Text Editing - Resource Sheet

**Category:** UI Component / Text Editing
**Type:** React Client Component
**File:** `packages/dashboard/src/widgets/notes/NotesWidget.tsx`
**Created:** 2026-01-08
**Lines of Code:** ~194 (NotesWidget) + ~150 (useLocalNotes) + ~180 (useAutoSave)
**Complexity:** Medium-High

---

**Generated by:** Resource Sheet Generation Workflow
**Timestamp:** 2026-01-08
**Auto-fill Rate:** Manual (comprehensive analysis)

---

## Executive Summary

**Element:** Notes Widget Text Editing System
**Category:** UI Component / Text Editing
**Purpose:** Provides a multi-card text editing interface for creating, editing, and managing markdown notes with localStorage persistence and optional file system saving.

**Key Responsibilities:**
- **Text Editing:** Provides textarea and input elements for editing note content and titles
- **State Management:** Manages note state (title, content, saved status) via `useLocalNotes` hook
- **Persistence:** Auto-saves to localStorage and supports manual save to file system
- **Multi-Card Interface:** Displays exactly 3 note cards simultaneously (always shows 3, creates empty cards if needed)
- **Save Operations:** Handles saving notes to `coderef/notes/` directory via API

**Not Responsible For:**
- File system API implementation (handled by `CodeRefApi.notes.save`)
- Markdown rendering/preview (currently text-only editing)
- Rich text editing (plain text/markdown only)
- Note encryption or sharing

---

## Architecture Overview

### Component Hierarchy

```
NotesWidget (Main Container)
├── Note Card 1
│   ├── Title Input (text editing)
│   ├── Content Textarea (text editing)
│   └── Footer (Status + Save/Delete buttons)
├── Note Card 2
│   └── (same structure)
└── Note Card 3
    └── (same structure)
```

### Dependencies

**Internal:**
- `useLocalNotes`: Hook for managing note state and localStorage persistence
- `useProjects`: Context hook for getting current project root
- `CodeRefApi.notes.save`: API client for saving notes to file system

**External:**
- `lucide-react`: Icons (Save, Trash2)
- `react`: Core React hooks (useState, useEffect, useCallback)

### Key Files

1. **`NotesWidget.tsx`** - Main component with UI and event handlers
2. **`hooks/useLocalNotes.ts`** - State management and localStorage persistence
3. **`hooks/useAutoSave.ts`** - Auto-save with debouncing (available but not currently used in main widget)
4. **`types.ts`** - TypeScript interfaces for notes

---

## Text Editing Functions

### 1. Content Textarea (Primary Text Editing)

**Location:** `packages/dashboard/src/widgets/notes/NotesWidget.tsx:148-153`

```tsx
<textarea
  placeholder="Start writing..."
  value={note.content}
  onChange={e => updateNote(note.id, { content: e.target.value })}
  className="flex-1 resize-none bg-transparent text-ind-text text-sm focus:outline-none mb-3"
/>
```

**Purpose:** Main text editing interface for note content
**Behavior:**
- Controlled component (value bound to `note.content`)
- Updates trigger `updateNote` callback immediately
- Changes persist to localStorage automatically via `useLocalNotes` hook
- Full-height textarea (flex-1) with no resize

### 2. Title Input (Title Editing)

**Location:** `packages/dashboard/src/widgets/notes/NotesWidget.tsx:139-145`

```tsx
<input
  type="text"
  placeholder="Untitled"
  value={note.title}
  onChange={e => updateNote(note.id, { title: e.target.value })}
  className="bg-transparent border-b border-ind-border px-2 py-1 mb-3 text-ind-text font-semibold focus:outline-none focus:border-ind-accent"
/>
```

**Purpose:** Editable note title/name
**Behavior:**
- Controlled component (value bound to `note.title`)
- Updates trigger `updateNote` callback immediately
- Changes persist to localStorage automatically
- Used as filename when saving to file system

### 3. updateNote Function (Core Text Editing Handler)

**Location:** `packages/dashboard/src/widgets/notes/hooks/useLocalNotes.ts:102-110`

```typescript
const updateNote = useCallback((id: string, updates: Partial<Pick<LocalNote, 'title' | 'content'>>) => {
  setNotes(prev =>
    prev.map(note =>
      note.id === id
        ? { ...note, ...updates, lastModified: new Date().toISOString() }
        : note
    )
  );
}, []);
```

**Purpose:** Core function that handles all text editing updates
**Behavior:**
- Updates note state in React state
- Automatically updates `lastModified` timestamp
- Triggers localStorage persistence via `useEffect` in `useLocalNotes`
- Supports partial updates (title or content independently)

**Called From:**
- Content textarea `onChange` handler
- Title input `onChange` handler

---

## State Management

### LocalNote Interface

```typescript
interface LocalNote {
  id: string;                    // Unique identifier
  title: string;                 // Note title (editable)
  content: string;               // Note content (editable)
  savedToFile: boolean;          // Whether saved to file system
  filename?: string;             // Filename if saved
  lastModified: string;         // ISO timestamp
}
```

### State Flow

1. **User Types:** User types in textarea or input
2. **onChange Event:** Triggers `updateNote(note.id, { content/title: value })`
3. **State Update:** `useLocalNotes.updateNote` updates React state
4. **Auto-Persist:** `useEffect` in `useLocalNotes` saves to localStorage
5. **UI Update:** Component re-renders with new value

### localStorage Persistence

**Storage Key:** `coderef-local-notes`
**Format:** JSON array of `LocalNote[]`
**Persistence:** Automatic on every state change (via `useEffect`)

**Load on Mount:**
- Reads from localStorage on component mount
- Creates 3 default blank cards if no notes exist
- Handles JSON parse errors gracefully

---

## Integration Points

### Parent Components

- **Route:** `/notes` page renders `NotesWidget` directly
- **Layout:** Full-height container with industrial theme styling

### Dependencies

- **ProjectsContext:** Provides `projectRoot` for file system saves
- **CodeRefApi.notes.save:** API client for saving to `coderef/notes/` directory
- **localStorage:** Browser storage for note persistence

### Save to File System

**Function:** `handleSaveNote` (NotesWidget.tsx:41-77)

**Process:**
1. Validates project root exists
2. Validates title is not empty
3. Ensures filename has `.md` extension
4. Calls `CodeRefApi.notes.save(projectRoot, filename, content)`
5. Updates note state to mark as saved
6. Shows save status in UI

**File Location:** `<projectRoot>/coderef/notes/<filename>.md`

---

## UI/UX Patterns

### Multi-Card Layout

- **Always Shows 3 Cards:** Widget always displays exactly 3 note cards
- **Empty Cards:** Creates temporary empty cards if less than 3 notes exist
- **Equal Width:** Each card uses `flex-1` for equal distribution
- **Gap Spacing:** 4-unit gap between cards (`gap-4`)

### Save Status Indicators

- **Local Draft:** Shows "Local draft" for unsaved notes
- **Saved:** Shows "✓ Saved to {filename}" for saved notes
- **Saving:** Save button shows loading state during save operation

### Industrial Theme

- **Background:** `bg-ind-panel` for cards
- **Borders:** `border-ind-border` for card borders
- **Text:** `text-ind-text` for content, `text-ind-text-muted` for secondary
- **Accent:** `text-ind-accent` for focus states

---

## Keyboard Shortcuts

**Cmd/Ctrl+N:** Create new note
- Implemented in `useEffect` with keydown listener
- Prevents default browser behavior
- Calls `handleCreateNote`

**Note:** Manual save (Cmd/Ctrl+S) is not currently implemented but could be added via `useAutoSave.triggerSave()`

---

## Common Pitfalls

1. **No Auto-Save to File System:** 
   - Text editing updates localStorage only
   - Users must manually click Save button to persist to file system
   - Consider integrating `useAutoSave` hook for automatic file saves

2. **Always 3 Cards:**
   - Widget always shows 3 cards, even if empty
   - Empty cards are temporary and not persisted
   - May confuse users expecting dynamic card count

3. **No Validation:**
   - Title can be empty when saving
   - No character limits on content
   - No file size warnings before save

4. **localStorage Quota:**
   - No handling for localStorage quota exceeded errors
   - Large notes could fail silently
   - Consider adding quota detection and warnings

5. **No Undo/Redo:**
   - Browser default undo (Cmd/Ctrl+Z) works in textarea
   - No custom undo/redo stack for note operations

6. **No Conflict Resolution:**
   - If same filename exists, save may overwrite without warning
   - No versioning or conflict detection

---

## Testing Strategy

### Unit Tests

- `updateNote` function updates correct note
- localStorage persistence saves/loads correctly
- Empty cards created when less than 3 notes exist

### Integration Tests

- Text editing updates state and localStorage
- Save button persists to file system
- Delete button removes note from state
- Keyboard shortcut creates new note

### Manual Tests

- Type in textarea → verify localStorage update
- Save note → verify file created in `coderef/notes/`
- Delete note → verify removed from UI and localStorage
- Refresh page → verify notes restored from localStorage

---

## Future Enhancements

1. **Auto-Save Integration:**
   - Integrate `useAutoSave` hook for automatic file system saves
   - Add debounced save (500ms delay)
   - Show save status indicator

2. **Markdown Preview:**
   - Add preview mode toggle
   - Use `react-markdown` for rendering
   - Syntax highlighting for code blocks

3. **Rich Text Editing:**
   - Consider markdown toolbar (bold, italic, links)
   - Or switch to rich text editor (Tiptap, Slate)

4. **Note Management:**
   - Dynamic card count (not always 3)
   - Note list sidebar
   - Search/filter notes

5. **Validation:**
   - Title required before save
   - Content size limits
   - Filename validation

---

## Related Documentation

- **Workorder:** `coderef/workorder/text-editor/plan.json`
- **API Client:** `packages/dashboard/src/lib/coderef/api-access.ts`
- **Types:** `packages/dashboard/src/widgets/notes/types.ts`

---

**Complexity Score:** Medium-High
**Modules Used:** react-hooks, localStorage-persistence, file-system-api
**Last Updated:** 2026-01-08
