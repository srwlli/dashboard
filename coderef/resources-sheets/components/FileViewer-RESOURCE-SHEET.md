---
agent: Claude Sonnet 4.5
date: "2026-01-14"
task: UPDATE
subject: FileViewer
parent_project: coderef-dashboard
category: component
version: 1.0.0
related_files:
  - packages/dashboard/src/components/coderef/FileViewer.tsx
status: APPROVED
---

# FileViewer - Resource Sheet

**Category:** UI Component
**Type:** React Client Component
**File:** `packages/dashboard/src/components/coderef/FileViewer.tsx`
**Created:** 2026-01-04
**Lines of Code:** ~490
**Complexity:** Medium

---

**Generated by:** Resource Sheet Generation Workflow
**Timestamp:** 2026-01-04
**Auto-fill Rate:** Manual (comprehensive analysis)

---

## Executive Summary

**Element:** FileViewer
**Category:** UI Component
**Purpose:** Displays file contents with syntax highlighting, rich media rendering (Markdown, Mermaid, HTML), and utility features (Copy, Share, Expand).

**Key Responsibilities:**
- Fetching file content via `hybrid-router` (Local or API).
- Rendering different file types appropriately:
  - **Code:** Syntax highlighting via `react-syntax-highlighter`.
  - **Markdown:** Rich text via `react-markdown` with syntax-highlighted code blocks.
  - **Mermaid:** Diagrams via `MermaidViewer`.
  - **HTML:** Sandboxed iframe preview.
  - **JSON:** Pretty-printed.
- Managing loading, error, and empty states.
- Providing utility actions: Copy Path, Copy Content, Share, Expand to Full Page.

**Not Responsible For:**
- File editing (Read-only).
- File tree navigation.
- Project selection.

---

## Architecture Overview

### Dependencies

**Internal:**
- `hybrid-router`: For loading content (`loadFileContent`).
- `types`: For `Project`, `FileInfo`, `AccessMode`.
- `MermaidViewer`: For rendering `.mmd` files.

**External:**
- `react-syntax-highlighter`: For code blocks.
- `react-markdown`: For `.md` files.
- `remark-gfm`: For GitHub Flavored Markdown support (tables, strikethrough, task lists, etc.).
- `rehype-slug`: For Markdown anchor links.
- `lucide-react`: For icons.

### State Management

- `fileData` (`FileInfo | null`): Content and metadata of the current file.
- `loading` (`boolean`): Fetch status.
- `error` (`string | null`): Error message.
- `accessMode` (`'local' | 'api'`): Indicator of how the file was loaded (via File System Access API or HTTP).
- `copied`, `copiedPath`, `shared` (`boolean`): Transient UI states for button feedback.

### Data Flow

1. **Props Change:** `project` or `filePath` updates.
2. **Effect Trigger:** `useEffect` calls `loadFile`.
3. **Fetch:** `loadFileContent` (hybrid router) determines best loading method.
4. **Render:**
   - Checks extension (`.ts`, `.md`, etc.).
   - Selects appropriate renderer (SyntaxHighlighter, ReactMarkdown, etc.).

### Utility Functions

- **`extractMermaidCode(content: string): string`** - Removes metadata blocks from `.mmd` files to prevent parsing errors. Handles metadata markers like "Diagram Summary:", "Tip:", "Format:" and stops processing after classDef blocks. This ensures only valid Mermaid syntax is passed to the MermaidViewer component.

- **`formatFileSize(bytes: number): string`** - Formats file sizes in human-readable format (B, KB, MB, GB). Used in the file header display to show file size information to users.

---

## Supported Formats

| Type | Extensions | Renderer |
| :--- | :--- | :--- |
| **Code** | `.ts`, `.tsx`, `.js`, `.jsx`, `.py`, `.java`, `.c`, `.cpp`, `.rs`, `.go` | `Prism` (VSCode Dark Plus) |
| **Markdown** | `.md` | `ReactMarkdown` + `remark-gfm` + `rehype-slug` (supports tables, strikethrough, task lists) |
| **Mermaid** | `.mmd` | `<MermaidViewer />` (uses `extractMermaidCode()` to remove metadata) |
| **HTML** | `.html`, `.htm` | `<iframe sandbox="..." />` |
| **JSON** | `.json` | `JSON.stringify(parsed, null, 2)` |
| **Binary** | Images, etc. | "Binary file preview not available" |

---

## UI Features

### File Header

The file header displays comprehensive file information:
- **File Name**: Truncated with ellipsis if too long
- **Access Mode Badge**: Visual indicator showing how the file was loaded:
  - "Local" (Zap icon, green) - Loaded via File System Access API
  - "API" (Cloud icon, blue) - Loaded via HTTP API
- **File Size**: Human-readable formatted size (B, KB, MB, GB)
- **File Path**: Full file path displayed in monospace font

### Action Buttons

Four utility buttons with visual feedback states:

1. **Expand** (Maximize2 icon) - Opens file in full-page viewer at `/viewer/full`
2. **Path** (FolderTree icon) - Copies full file path to clipboard. Handles `[Directory: ...]` wrapper removal from project paths.
3. **Copy** (Copy icon) - Copies file content to clipboard
4. **Share** (Share2 icon) - Uses Web Share API if available, otherwise falls back to clipboard

All buttons show visual feedback on success:
- Checkmark icon (green) replaces action icon
- Button text changes to "Copied", "Shared", or "Path Copied"
- Feedback automatically resets after 2 seconds

---

## Integration Points

- **Parent:** Typically rendered by `CodeRefExplorerWidget` or `FullPageViewer`.
- **Navigation:** Uses `useRouter` for "Expand" functionality (navigates to `/viewer/full`).
- **Storage:** Writes to `sessionStorage` (`fullPageViewerProject`) to pass context to the full-page viewer without URL clutter.

---

## Common Pitfalls

1. **Binary Files:** Currently shows a placeholder. No image preview yet.
2. **Large Files:** No virtualization. Very large files (>1MB) might lag the DOM.
3. **Encoding:** Assumes UTF-8. Base64 content is strictly for binary detection, not decoding.
4. **Debug Logging:** Console logging for Mermaid files (extension, encoding, content preview) is present for development. Consider removing in production builds.

---

**Complexity Score:** Medium
**Modules Used:** syntax-highlighting, markdown-rendering, hybrid-routing
