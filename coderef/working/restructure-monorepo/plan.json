{
  "META_DOCUMENTATION": {
    "plan_id": "WO-RESTRUCTURE-MONOREPO-001",
    "plan_name": "Restructure Monorepo",
    "status": "ready_for_implementation",
    "estimated_effort_days": 3,
    "priority": "high",
    "created_date": "2025-12-25T18:15:00Z",
    "last_updated": "2025-12-25T18:15:00Z"
  },
  "UNIVERSAL_PLANNING_STRUCTURE": {
    "0_preparation": {
      "name": "Preparation Phase",
      "checklist": [
        "Review context.json and requirements",
        "Review analysis.json and project structure",
        "Understand current architecture and type declaration conflicts",
        "Verify PromptingWorkflow component is fully implemented",
        "Confirm git repository is clean",
        "Plan file movements and deletions in correct order"
      ],
      "prerequisites": "All context and analysis documents completed",
      "estimated_duration": "1-2 hours"
    },
    "1_executive_summary": {
      "description": "Restructure monorepo to simplify architecture by removing the widget system and consolidating PromptingWorkflow as a direct component. This addresses critical TypeScript build failures caused by duplicate type declarations in packages/core, packages/widgets, and packages/dashboard simultaneously declaring Window.CodeRefCore with incompatible type signatures. Current architecture requires custom build-widgets.js script that creates IIFE bundles, adding unnecessary complexity for a single component. The restructure removes packages/widgets/ directory, moves PromptingWorkflow component to packages/dashboard/src/components/, and eliminates custom bundling, reducing build time and resolving type conflicts.",
      "business_value": [
        "Fix TypeScript compilation errors that currently block the build",
        "Simplify build pipeline by removing custom widget bundling system",
        "Reduce codebase complexity and ongoing maintenance overhead",
        "Prepare architecture for future feature additions without widget infrastructure",
        "Decrease build time by eliminating build-widgets.js execution phase"
      ],
      "scope": "Monorepo restructuring: remove packages/widgets/, move component to dashboard, update build configuration and NPM workspaces",
      "in_scope": [
        "Delete packages/widgets/ directory and @coderef-dashboard namespace",
        "Move PromptingWorkflow to packages/dashboard/src/components/",
        "Remove build-widgets.js script from scripts/ directory",
        "Update package.json build scripts and workspaces array",
        "Update tsconfig.json to remove widget exclusions",
        "Update coderef-dashboard.config.json to remove widget loader config",
        "Test web and Electron builds for full functionality",
        "Verify TypeScript compilation with zero errors"
      ],
      "out_of_scope": [
        "Adding new features to PromptingWorkflow component",
        "Fixing scroll issues on web or Electron apps",
        "Redesigning component architecture beyond removing widget wrapper",
        "Database or persistent storage implementation",
        "Performance optimization beyond what restructuring provides"
      ]
    },
    "2_risk_assessment": {
      "critical_risks": [
        {
          "risk": "TypeScript compilation failures during restructuring",
          "probability": "high",
          "impact": "Build pipeline broken; development blocked",
          "mitigation": "Incrementally perform deletions and validate with type-check after each phase; maintain git commits for easy rollback"
        },
        {
          "risk": "Incomplete file movements causing missing components",
          "probability": "low",
          "impact": "Application runtime errors; UI components missing",
          "mitigation": "Create checklist of all 18 files (8 components + 7 utilities + 3 hooks); verify each file copied successfully"
        }
      ],
      "major_risks": [
        {
          "risk": "Electron app breaks after configuration changes",
          "probability": "medium",
          "impact": "Desktop application non-functional",
          "mitigation": "Test electron build and runtime after each configuration change; have rollback plan ready"
        },
        {
          "risk": "Web app fails to render PromptingWorkflow after move",
          "probability": "medium",
          "impact": "Dashboard non-functional",
          "mitigation": "Update all import paths in page.tsx; test dev server after file moves"
        },
        {
          "risk": "npm install fails due to broken workspaces configuration",
          "probability": "low",
          "impact": "Cannot run dev or build commands",
          "mitigation": "Run npm install after workspace array changes; verify all packages resolve"
        }
      ],
      "edge_cases": [
        {
          "case": "Circular import dependencies after file move",
          "probability": "low",
          "handling": "Check for circular dependencies with npm-check-circular or similar; refactor imports if found"
        },
        {
          "case": "CSS Module paths broken in moved components",
          "probability": "medium",
          "handling": "Verify all .module.css imports match new file structure; update paths if relative imports affected"
        },
        {
          "case": "Global declarations in hooks still causing conflicts",
          "probability": "low",
          "handling": "Ensure no declare global statements in moved hook files; remove CodeRefCore type declarations"
        },
        {
          "case": "Package.json exports field references deleted packages",
          "probability": "low",
          "handling": "Audit any exports fields in root package.json for widget package references"
        },
        {
          "case": "Build cache contains stale references to widget package",
          "probability": "low",
          "handling": "Run npm cache clean --force; delete .next and node_modules/.cache if needed"
        }
      ]
    },
    "3_current_state_analysis": {
      "existing_implementation": "PromptingWorkflow component fully implemented in packages/dashboard/src/widgets/PromptingWorkflow/ with 8 React components, 7 utility files, 3 custom hooks, comprehensive types, and matching CSS modules. Original widget package exists in packages/widgets/@coderef-dashboard/widget-prompting-workflow/ but is now obsolete due to shift from IIFE bundling to direct component approach.",
      "files_to_delete": {
        "directory": "packages/widgets/",
        "file_count": "approximately 45 files",
        "size_estimate": "approximately 600KB",
        "includes": "package.json, src/, dist/, node_modules/, tsconfig.json, etc."
      },
      "files_to_move": {
        "source": "packages/dashboard/src/widgets/PromptingWorkflow/",
        "destination": "packages/dashboard/src/components/PromptingWorkflow/",
        "components": 8,
        "utilities": 7,
        "hooks": 3,
        "types_file": 1,
        "index_file": 1,
        "css_modules": 9,
        "total_files": 29
      },
      "configuration_files_to_update": [
        "package.json: Remove 'build:widgets' script and update build script",
        "package.json: Remove 'packages/widgets/@coderef-dashboard/*' from workspaces",
        "tsconfig.json: Remove '../widgets' from exclude array if present",
        "coderef-dashboard.config.json: Remove prompting-workflow widget entry",
        "scripts/build-widgets.js: Delete this file entirely"
      ],
      "type_declaration_locations": [
        "packages/core/src/index.ts: CodeRefCore optional declaration",
        "packages/widgets/widget-prompting-workflow/hooks: Remove declare global (deprecated)",
        "packages/dashboard/src/widgets/PromptingWorkflow: No global declarations needed"
      ],
      "estimated_lines_of_code_to_remove": "approximately 1500 lines from widget package"
    },
    "4_key_features": {
      "primary_objectives": [
        "Eliminate TypeScript build errors caused by conflicting type declarations",
        "Simplify monorepo structure from 4 workspaces to 3 workspaces",
        "Consolidate PromptingWorkflow as a direct Next.js component"
      ],
      "success_criteria": [
        "npm run build completes without any errors (0 failures)",
        "npm run type-check returns 0 TypeScript errors",
        "npm run dev starts dashboard successfully on localhost:3000",
        "npm run dev:electron starts Electron app without errors",
        "PromptingWorkflow component renders and displays on dashboard",
        "All PromptingWorkflow features functional: file upload (100% success rate), prompt selection (3 preloaded prompts all work), export to clipboard (successful copy), JSON export (valid structure), Markdown export (valid format)",
        "No console errors or warnings in browser DevTools",
        "No console errors or warnings in Electron DevTools",
        "packages/widgets/ directory completely removed from filesystem",
        "scripts/build-widgets.js completely removed from filesystem"
      ]
    },
    "5_task_id_system": {
      "prefix": "RESTRUCTURE",
      "total_tasks": 24,
      "phase_1_preparation": {
        "name": "Preparation & Validation",
        "id_range": "001-003",
        "task_count": 3
      },
      "phase_2_move_files": {
        "name": "Move Component Files",
        "id_range": "004-008",
        "task_count": 5
      },
      "phase_3_delete": {
        "name": "Delete Widget Package",
        "id_range": "009-012",
        "task_count": 4
      },
      "phase_4_configure": {
        "name": "Update Configuration",
        "id_range": "013-018",
        "task_count": 6
      },
      "phase_5_testing": {
        "name": "Testing & Validation",
        "id_range": "019-024",
        "task_count": 6
      }
    },
    "6_implementation_phases": {
      "phase_1_preparation_and_validation": {
        "name": "Preparation & Validation",
        "duration_days": 0.5,
        "description": "Verify project state, backup configuration, and audit all files that will be moved or deleted to ensure nothing critical is missed.",
        "tasks": [
          {
            "id": "RESTRUCTURE-001",
            "title": "Create backup and verify git status",
            "description": "Ensure git repository is in a clean state with all changes committed. Verify that we can safely perform destructive operations and easily rollback if needed by checking git log and status.",
            "acceptance_criteria": "git status shows 'nothing to commit, working tree clean' and git log shows recent commits",
            "depends_on": []
          },
          {
            "id": "RESTRUCTURE-002",
            "title": "Audit current PromptingWorkflow component implementation",
            "description": "Verify all 8 component files, 7 utility files, 3 hook files, types file, and index file are present in packages/dashboard/src/widgets/PromptingWorkflow/ with matching CSS modules. Create inventory spreadsheet.",
            "acceptance_criteria": "All 29 files accounted for; inventory spreadsheet created with file hashes for verification after move",
            "depends_on": ["RESTRUCTURE-001"]
          },
          {
            "id": "RESTRUCTURE-003",
            "title": "Document widget package structure and dependencies",
            "description": "Create comprehensive inventory of packages/widgets/@coderef-dashboard/widget-prompting-workflow/ including all source files, build outputs, configuration files, and dependency declarations to ensure nothing critical is accidentally deleted.",
            "acceptance_criteria": "Complete file tree documented; any external dependencies identified; ready to delete with confidence",
            "depends_on": []
          }
        ]
      },
      "phase_2_move_component_files": {
        "name": "Move Component Files",
        "duration_days": 1,
        "description": "Move all PromptingWorkflow implementation files from the widget package to the new component location within the dashboard package.",
        "tasks": [
          {
            "id": "RESTRUCTURE-004",
            "title": "Create destination directory structure in dashboard package",
            "description": "Create new directory structure packages/dashboard/src/components/PromptingWorkflow/ with subdirectories for components/, hooks/, and utils/, matching the source structure exactly. Verify directory hierarchy is correct before proceeding to file movement.",
            "acceptance_criteria": "Directory structure created; matches source structure; all subdirectories present (components, hooks, utils)",
            "depends_on": ["RESTRUCTURE-002"]
          },
          {
            "id": "RESTRUCTURE-005",
            "title": "Move all component files to destination components subdirectory",
            "description": "Copy all 8 React TypeScript component files (.tsx) and corresponding CSS module files (.module.css) from source to destination components/ directory. Verify file count matches inventory.",
            "acceptance_criteria": "All 16 files moved (8 tsx + 8 css); md5 hashes match inventory; verified with file listing",
            "depends_on": ["RESTRUCTURE-004"]
          },
          {
            "id": "RESTRUCTURE-006",
            "title": "Move all utility files to destination utils subdirectory",
            "description": "Copy all 7 utility TypeScript files from source utils/ directory to destination utils/ directory including tokenEstimator, languageMap, fileContentExtractor, filenameGenerator, prompts, exportFormatter, and any others.",
            "acceptance_criteria": "All 7 utility files moved; md5 hashes match; verified with file count",
            "depends_on": ["RESTRUCTURE-004"]
          },
          {
            "id": "RESTRUCTURE-007",
            "title": "Move all hook files to destination hooks subdirectory",
            "description": "Copy all 3 custom React hook files from source hooks/ directory to destination hooks/ directory: useWorkflow.ts, useClipboard.ts, and useFileHandlers.ts. Verify all hooks are copied with correct TypeScript imports and no global declarations.",
            "acceptance_criteria": "All 3 hook files moved; md5 hashes match; verified with file count",
            "depends_on": ["RESTRUCTURE-004"]
          },
          {
            "id": "RESTRUCTURE-008",
            "title": "Move types definition and index files to destination root",
            "description": "Copy types.ts and index.tsx from source root to destination root packages/dashboard/src/components/PromptingWorkflow/. Ensure no old index.ts exists that will cause import confusion. Verify imports reference correct paths.",
            "acceptance_criteria": "Both files moved; old index.ts deleted if present; index.tsx imports correct component paths",
            "depends_on": ["RESTRUCTURE-004"]
          }
        ]
      },
      "phase_3_delete_widget_package": {
        "name": "Delete Widget Package",
        "duration_days": 0.5,
        "description": "Remove references to widget system from configuration and delete the widget package entirely from the monorepo.",
        "tasks": [
          {
            "id": "RESTRUCTURE-009",
            "title": "Remove widget from dashboard configuration file",
            "description": "Edit packages/dashboard/public/coderef-dashboard.config.json and remove the entire prompting-workflow widget entry from the configuration. Verify JSON syntax is valid and properly formatted after the edit is complete.",
            "acceptance_criteria": "prompting-workflow removed from config; JSON is valid (no syntax errors); config JSON parseable",
            "depends_on": ["RESTRUCTURE-008"]
          },
          {
            "id": "RESTRUCTURE-010",
            "title": "Update page.tsx to use new direct component import path",
            "description": "Modify packages/dashboard/src/app/page.tsx to import PromptingWorkflow directly from './components/PromptingWorkflow' instead of using WidgetLoader pattern. Change from dynamic loading to static import.",
            "acceptance_criteria": "Import statement uses correct path; no WidgetLoader references remain; component renders in JSX",
            "depends_on": ["RESTRUCTURE-008"]
          },
          {
            "id": "RESTRUCTURE-011",
            "title": "Delete packages/widgets/ directory completely",
            "description": "Remove entire packages/widgets/ directory from filesystem, including @coderef-dashboard namespace, all source files, build outputs, and configuration. Verify deletion with file listing.",
            "acceptance_criteria": "Directory deleted; git status shows deletion; no files remain under packages/widgets/",
            "depends_on": ["RESTRUCTURE-009", "RESTRUCTURE-010"]
          },
          {
            "id": "RESTRUCTURE-012",
            "title": "Delete scripts/build-widgets.js file",
            "description": "Remove the custom widget build script scripts/build-widgets.js from the repository. This script is no longer needed with direct component approach.",
            "acceptance_criteria": "File deleted; git status shows deletion; file no longer exists in filesystem",
            "depends_on": ["RESTRUCTURE-011"]
          }
        ]
      },
      "phase_4_update_configuration": {
        "name": "Update Configuration",
        "duration_days": 0.5,
        "description": "Update all configuration files to reflect the new monorepo structure without the widget package.",
        "tasks": [
          {
            "id": "RESTRUCTURE-013",
            "title": "Update root package.json build scripts and remove build:widgets",
            "description": "Remove 'build:widgets' script definition and update 'build' script to remove 'npm run build:widgets &&' prefix. New build should simply be 'npm run build -ws --if-present' without widget build step.",
            "acceptance_criteria": "build:widgets script removed; build script updated; npm run build no longer tries to execute build-widgets.js",
            "depends_on": ["RESTRUCTURE-012"]
          },
          {
            "id": "RESTRUCTURE-014",
            "title": "Update root package.json workspaces array",
            "description": "Remove 'packages/widgets/@coderef-dashboard/*' entry from the workspaces array in root package.json. Keep only: packages/core, packages/dashboard, packages/electron-app. Verify the resulting JSON is valid and properly formatted.",
            "acceptance_criteria": "Widget workspace removed; only 3 workspaces remain; valid JSON",
            "depends_on": ["RESTRUCTURE-013"]
          },
          {
            "id": "RESTRUCTURE-015",
            "title": "Update dashboard package tsconfig.json exclusions",
            "description": "Remove '../widgets' from the exclude array in packages/dashboard/tsconfig.json if it is present there. Clean up any other widget-related configuration or exclusions. Verify tsconfig.json remains valid JSON after changes.",
            "acceptance_criteria": "Widget path removed from exclude; tsconfig is valid JSON; TypeScript can parse",
            "depends_on": ["RESTRUCTURE-013"]
          },
          {
            "id": "RESTRUCTURE-016",
            "title": "Verify type declarations in core package are optional",
            "description": "Confirm that packages/core/src/index.ts declares Window.CodeRefCore as optional with syntax (CodeRefCore?: ...). All nested properties should also be optional to prevent type conflicts. Verify TypeScript compiles without global conflicts.",
            "acceptance_criteria": "CodeRefCore declaration is optional; all nested properties are optional; TypeScript compiles without global conflicts",
            "depends_on": ["RESTRUCTURE-014"]
          },
          {
            "id": "RESTRUCTURE-017",
            "title": "Verify WidgetLoader component is not used or remove if unused",
            "description": "Check if WidgetLoader component exists in dashboard/src/components/ and is no longer referenced. Remove if present and no other components depend on it.",
            "acceptance_criteria": "WidgetLoader removal verified; no remaining imports of WidgetLoader; grep search returns no results",
            "depends_on": ["RESTRUCTURE-010"]
          },
          {
            "id": "RESTRUCTURE-018",
            "title": "Clean npm cache and reinstall all dependencies",
            "description": "Run 'npm cache clean --force' to clear any cached widget package references, then run 'npm install' to verify all dependencies resolve correctly with new workspace structure.",
            "acceptance_criteria": "npm install succeeds without errors; package-lock.json updated; all packages resolvedsucccessfully",
            "depends_on": ["RESTRUCTURE-014"]
          }
        ]
      },
      "phase_5_testing_and_validation": {
        "name": "Testing & Validation",
        "duration_days": 1,
        "description": "Comprehensive testing to ensure web and Electron apps function correctly after restructuring.",
        "tasks": [
          {
            "id": "RESTRUCTURE-019",
            "title": "Run TypeScript type-check across all workspaces",
            "description": "Execute 'npm run type-check' to verify TypeScript compilation succeeds with zero type errors across all workspaces: core, dashboard, and electron-app packages. Verify no TypeScript diagnostic messages are reported.",
            "acceptance_criteria": "Command completes successfully; output shows 0 type errors; no TypeScript diagnostics reported",
            "depends_on": ["RESTRUCTURE-018"]
          },
          {
            "id": "RESTRUCTURE-020",
            "title": "Build dashboard web application with Turbopack",
            "description": "Execute 'npm run build:dashboard' to verify that Next.js Turbopack build succeeds completely. Check for any build errors, warnings, or unresolved module imports that indicate configuration problems.",
            "acceptance_criteria": "Build succeeds; next directory created; build artifacts present; zero build errors",
            "depends_on": ["RESTRUCTURE-019"]
          },
          {
            "id": "RESTRUCTURE-021",
            "title": "Test web app locally with dev server",
            "description": "Run 'npm run dev' and open http://localhost:3000 in browser. Verify PromptingWorkflow component renders, all buttons work, file upload functions, export buttons accessible, and no console errors.",
            "acceptance_criteria": "Dev server starts successfully; page loads in <3 seconds; PromptingWorkflow visible; no red errors in console",
            "depends_on": ["RESTRUCTURE-020"]
          },
          {
            "id": "RESTRUCTURE-022",
            "title": "Build Electron application",
            "description": "Execute 'npm run build:electron' to verify Electron build succeeds. Check for build errors related to widget package removal or missing dependencies.",
            "acceptance_criteria": "Build completes; output artifacts created; zero errors; dist/ directory contains compiled app",
            "depends_on": ["RESTRUCTURE-019"]
          },
          {
            "id": "RESTRUCTURE-023",
            "title": "Test Electron app locally with dev server",
            "description": "Run 'npm run dev:electron' and verify Electron window opens with dashboard. Confirm PromptingWorkflow renders, all features work (file upload, export), and no console errors in main or renderer process.",
            "acceptance_criteria": "Electron window opens; dashboard loads; component visible; features work; DevTools shows no errors",
            "depends_on": ["RESTRUCTURE-022"]
          },
          {
            "id": "RESTRUCTURE-024",
            "title": "Verify git history and create final restructure commit",
            "description": "Review all git changes to ensure clean history. Stage all deletions and modifications. Create a comprehensive commit message documenting the restructuring work with summary of removed files and changes.",
            "acceptance_criteria": "Git log shows atomic commit; commit message describes restructure; no uncommitted changes remain",
            "depends_on": ["RESTRUCTURE-023"]
          }
        ]
      }
    },
    "7_testing_strategy": {
      "unit_tests": "Not applicable - restructuring is pure file movement and configuration changes with no logic modifications",
      "integration_tests": [
        "Verify TypeScript compilation completes with zero errors",
        "Verify build pipeline executes without errors for web",
        "Verify build pipeline executes without errors for Electron",
        "Verify web app renders component correctly",
        "Verify Electron app renders component correctly",
        "Verify component functionality (file upload, export, selection)"
      ],
      "manual_testing_checklist": [
        "Test file drag-and-drop upload in web app",
        "Test file paste functionality in web app",
        "Test file selection dialog in web app",
        "Test prompt selection (Code Review, Synthesize, Consolidate) in web app",
        "Test clipboard export in web app",
        "Test JSON export format in web app",
        "Test Markdown export format in web app",
        "Repeat same tests in Electron app",
        "Verify console DevTools shows zero errors in both",
        "Verify no TypeScript warnings in terminal"
      ],
      "test_environment": "Local development environment with Node.js 18+, npm 9+",
      "rollback_plan": "If critical failures occur, use 'git revert' to undo the restructure commit and return to previous state",
      "success_criteria": "Both web and Electron apps fully functional with PromptingWorkflow component rendering and all features operational; zero TypeScript errors; zero console errors"
    },
    "8_success_criteria": [
      "npm run build completes without errors (0 failures, 0 errors)",
      "npm run type-check reports 0 TypeScript compilation errors",
      "npm run dev starts dashboard dev server successfully within 30 seconds",
      "npm run dev:electron starts Electron app successfully within 30 seconds",
      "PromptingWorkflow component renders on dashboard page with all 8 sub-components visible",
      "File upload functionality works in web (drag-drop, paste, file dialog)",
      "File upload functionality works in Electron (drag-drop, paste, file dialog)",
      "Prompt selection dropdown displays all 3 preloaded prompts (Code Review, Synthesize, Consolidate)",
      "Export to clipboard button succeeds in copying workflow to system clipboard",
      "JSON export button generates valid JSON structure with all workflow data",
      "Markdown export button generates properly formatted Markdown document",
      "Browser DevTools console shows zero errors or warnings related to missing modules or broken imports",
      "Electron DevTools (both main and renderer) shows zero errors or warnings",
      "packages/widgets/ directory completely removed from filesystem",
      "scripts/build-widgets.js file completely removed from filesystem",
      "package.json contains no references to packages/widgets/ in workspaces or imports",
      "build:widgets script removed from package.json scripts section",
      "Web app fully responsive and usable after restructure"
    ],
    "9_implementation_checklist": [
      "[Phase 1] Prepare - verify git status and audit all files",
      "[Phase 1] Complete backup verification",
      "[Phase 2] Move all component files (8 tsx + 8 css = 16 files)",
      "[Phase 2] Move all utility files (7 files)",
      "[Phase 2] Move all hook files (3 files)",
      "[Phase 2] Move types and index files (2 files)",
      "[Phase 2] Verify 29 files moved successfully",
      "[Phase 3] Remove widget from config.json",
      "[Phase 3] Update page.tsx imports",
      "[Phase 3] Delete packages/widgets/ directory",
      "[Phase 3] Delete scripts/build-widgets.js",
      "[Phase 4] Update package.json build scripts",
      "[Phase 4] Update package.json workspaces",
      "[Phase 4] Update tsconfig exclusions",
      "[Phase 4] Verify core type declarations",
      "[Phase 4] Check WidgetLoader removal",
      "[Phase 4] npm cache clean and npm install",
      "[Phase 5] npm run type-check - zero errors",
      "[Phase 5] npm run build:dashboard - succeeds",
      "[Phase 5] npm run dev - web app renders correctly",
      "[Phase 5] npm run build:electron - succeeds",
      "[Phase 5] npm run dev:electron - Electron renders correctly",
      "[Phase 5] Manual testing of all features",
      "[Phase 5] Create final commit"
    ],
    "10_success_metrics": {
      "build_time_reduction": "Estimated 20-30% reduction by eliminating build-widgets.js phase",
      "code_removed_lines": "Approximately 1500 lines removed from widget package",
      "files_removed_count": "Approximately 45 files deleted from packages/widgets/",
      "configuration_files_updated": 4,
      "typescript_errors_reduction": "From 5+ errors to 0 errors",
      "monorepo_complexity_reduction": "From 4 workspaces to 3 workspaces",
      "implementation_time_estimate": "6-8 hours for complete execution",
      "rollback_risk": "Low - all changes tracked in git with atomic commit"
    }
  }
}
